<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore ë©”ëª¨ì¥</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }

        /* ë¦¬ìŠ¤íŠ¸: í•œ ì¤„ì— í•˜ë‚˜ */
        #noteList {
            display: flex;
            flex-direction: column;
            gap: 20px;
            list-style: none;
            padding: 0;
        }

        .note-card {
            border: 1px solid #e5e7eb;
            background-color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .note-content img {
            max-height: 300px;        /* ìš”ì²­í•œ ì œí•œ */
            max-width: 100%;
            border-radius: 10px;
            margin: 8px 0;
        }

        /* ëª¨ë‹¬ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto">

    <!-- ì œëª© -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ğŸ“ Firestore ë©”ëª¨ì¥</h1>

    <!-- ë¡œê·¸ì¸ ìƒíƒœ ë°•ìŠ¤ -->
    <div id="auth-box" class="p-4 bg-white rounded-xl shadow mb-6 flex justify-between items-center">
        <p id="auth-status" class="font-semibold text-indigo-700">Google ë¡œê·¸ì¸ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <p id="user-display" class="text-sm text-gray-600"></p>
    </div>

    <!-- ë©”ëª¨ ì‘ì„± ë°•ìŠ¤ -->
    <div class="p-6 bg-white rounded-xl shadow-lg mb-10">

        <!-- ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
        <div class="flex justify-end mb-3">
            <button id="google-login-btn"
                    onclick="signInWithGoogle()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700">
                Google ë¡œê·¸ì¸
            </button>

            <button id="logout-btn"
                    onclick="signOutUser()"
                    class="ml-3 px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 hidden">
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <textarea id="note-input" rows="5"
                  placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                  class="w-full p-4 border rounded-lg resize-none"
                  disabled></textarea>

        <button id="save-note-btn"
                onclick="saveNote()"
                class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg disabled:opacity-50"
                disabled>
            ì €ì¥
        </button>
    </div>

    <!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ -->
    <ul id="noteList"></ul>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div id="pagination" class="flex justify-center gap-2 mt-8"></div>
</div>
<script type="module">

/* ---------------------------
   Firebase Import
---------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    GoogleAuthProvider, 
    signInWithPopup, 
    signOut, 
    onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    updateDoc, 
    deleteDoc, 
    doc 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


/* ---------------------------
   Firebase ì„¤ì •
---------------------------- */
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyBq4P9oCU6pzJFRv_xxJyvG9moYjlHTeys",
    authDomain: "memo-f8ef8.firebaseapp.com",
    projectId: "memo-f8ef8",
    storageBucket: "memo-f8ef8.firebasestorage.app",
    messagingSenderId: "92169207764",
    appId: "1:92169207764:web:b2b078dcfe8d38dcf62041",
    measurementId: "G-X6GT0JDL7S"
};

const app = initializeApp(FIREBASE_CONFIG);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);


/* ---------------------------
   ê¸€ë¡œë²Œ ë³€ìˆ˜
---------------------------- */
let userId = null;
let allNotes = [];
let currentPage = 1;
const NOTES_PER_PAGE = 20;


/* ---------------------------
   DOM ìš”ì†Œ
---------------------------- */
const noteInput = document.getElementById("note-input");
const saveNoteBtn = document.getElementById("save-note-btn");
const authBox = document.getElementById("auth-box");
const authStatus = document.getElementById("auth-status");
const userDisplay = document.getElementById("user-display");
const googleLoginBtn = document.getElementById("google-login-btn");
const logoutBtn = document.getElementById("logout-btn");
const noteList = document.getElementById("noteList");
const pagination = document.getElementById("pagination");


/* ---------------------------
   ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ
---------------------------- */
window.signInWithGoogle = async function () {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
    } catch (err) {
        alert("Google ë¡œê·¸ì¸ ì‹¤íŒ¨");
        console.error(err);
    }
};

window.signOutUser = async function () {
    try {
        await signOut(auth);
    } catch (err) {
        alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
        console.error(err);
    }
};


/* ---------------------------
   ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
---------------------------- */
onAuthStateChanged(auth, async (user) => {

    if (user) {
        userId = user.uid;

        authStatus.textContent = "";
        userDisplay.textContent = `${user.email}`;
        googleLoginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

        noteInput.disabled = false;
        saveNoteBtn.disabled = false;

        loadAllNotes();

    } else {
        userId = null;

        authStatus.textContent = "Google ë¡œê·¸ì¸ í•„ìš”í•©ë‹ˆë‹¤.";
        userDisplay.textContent = "";
        googleLoginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");

        noteInput.disabled = true;
        saveNoteBtn.disabled = true;

        allNotes = [];
        renderNotes();
    }
});


/* ---------------------------
   Firestore ê²½ë¡œ helpers
---------------------------- */
function notesCollection() {
    return collection(db, `users/${userId}/notes`);
}


/* ---------------------------
   1) ë©”ëª¨ ì „ì²´ ë¡œë“œ (ì˜µì…˜ A í˜ì´ì§• ë°©ì‹)
---------------------------- */
async function loadAllNotes() {
    if (!userId) return;

    const snapshot = await getDocs(notesCollection());
    const temp = [];

    snapshot.forEach(docItem => {
        temp.push({ id: docItem.id, ...docItem.data() });
    });

    allNotes = temp.sort((a,b)=> new Date(b.date) - new Date(a.date));

    renderNotes();
}


/* ---------------------------
   2) ë©”ëª¨ ì €ì¥
---------------------------- */
window.saveNote = async function () {
    if (!userId) return;

    const text = noteInput.value.trim();
    if (!text) {
        alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
    }

    await addDoc(notesCollection(), {
        content: text,
        date: new Date().toISOString()
    });

    noteInput.value = "";
    loadAllNotes();
};


/* ---------------------------
   3) ë©”ëª¨ ì‚­ì œ
---------------------------- */
window.deleteNote = async function (id) {
    const isConfirm = confirm("ì •ë§ ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (!isConfirm) return;  // ì·¨ì†Œí•˜ë©´ ì‚­ì œ ì•ˆ í•¨
    
    await deleteDoc(doc(db, `users/${userId}/notes/${id}`));
    loadAllNotes();
};


/* ---------------------------
   4) ë©”ëª¨ ìˆ˜ì •
---------------------------- */
window.updateNote = async function (id) {
    const newText = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!newText) return;

    await updateDoc(doc(db, `users/${userId}/notes/${id}`), {
        content: newText,
        date: new Date().toISOString()
    });

    loadAllNotes();
};


/* ---------------------------
   ë¶™ì—¬ë„£ê¸° ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥
---------------------------- */
noteInput.addEventListener("paste", async (event) => {

    const items = event.clipboardData.items;

    for (let item of items) {

        if (item.type.indexOf("image") === 0) {
            const file = item.getAsFile();

            const fileName = Date.now() + ".png";
            const storageRef = ref(storage, `users/${userId}/images/${fileName}`);

            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);

            // ë©”ëª¨ ì…ë ¥ì°½ì— img íƒœê·¸ ìë™ ì‚½ì…
            const imgTag = `<img src="${url}" style="max-height:300px; border-radius:8px;" />`;
            noteInput.value += "\n" + imgTag + "\n";
        }
    }
});


/* ---------------------------
   5) ë©”ëª¨ ë Œë”ë§ + í˜ì´ì§€ë„¤ì´ì…˜
---------------------------- */
function renderNotes() {

    noteList.innerHTML = "";

    const totalPages = Math.ceil(allNotes.length / NOTES_PER_PAGE);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    const startIndex = (currentPage - 1) * NOTES_PER_PAGE;
    const endIndex = startIndex + NOTES_PER_PAGE;

    const notesToShow = allNotes.slice(startIndex, endIndex);

    notesToShow.forEach(note => {
        const li = document.createElement("li");
        li.className = "note-card";

        li.innerHTML = `
            <p class="text-xs text-gray-500 mb-2">
                ${new Date(note.date).toLocaleString("ko-KR")}
            </p>

            <div class="note-content mb-3">
                ${note.content}
            </div>

            <div class="flex gap-2">
                <button onclick="updateNote('${note.id}')" 
                        class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded">
                    ìˆ˜ì •
                </button>

                <button onclick="deleteNote('${note.id}')" 
                        class="px-3 py-1 text-sm bg-red-100 text-red-600 rounded">
                    ì‚­ì œ
                </button>
            </div>
        `;

        noteList.appendChild(li);
    });

    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    pagination.innerHTML = "";

    if (totalPages <= 1) return;

    // ì´ì „ í˜ì´ì§€
    const prev = document.createElement("button");
    prev.textContent = "ì´ì „";
    prev.className = "px-3 py-1 bg-white border rounded";
    prev.disabled = currentPage === 1;
    prev.onclick = () => { currentPage--; renderNotes(); };
    pagination.appendChild(prev);

    // í˜ì´ì§€ ë²ˆí˜¸
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className =
            "px-3 py-1 rounded border " +
            (i === currentPage ? "bg-indigo-600 text-white" : "bg-white");

        btn.onclick = () => { currentPage = i; renderNotes(); };
        pagination.appendChild(btn);
    }

    // ë‹¤ìŒ í˜ì´ì§€
    const next = document.createElement("button");
    next.textContent = "ë‹¤ìŒ";
    next.className = "px-3 py-1 bg-white border rounded";
    next.disabled = currentPage === totalPages;
    next.onclick = () => { currentPage++; renderNotes(); };
    pagination.appendChild(next);
}

</script>
