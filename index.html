<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore ë©”ëª¨ì¥</title>
    <!-- Tailwind CSS ë¡œë”© -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        #noteList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            padding: 20px 0;
            list-style: none;
            margin: 0 auto; 
        }
        .note-card {
            border: 1px solid #e5e7eb;
            background-color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
            transition: transform 0.2s;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
        }
        /* ë©”ëª¨ ë‚´ìš© ì¤„ ì œí•œ ì—†ìŒ */
        .note-content {
            white-space: pre-wrap; 
            word-break: break-word; 
            flex-grow: 1;
            margin-top: 8px;
            line-height: 1.5;
            color: #4b5563;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">ğŸ”’ Firestore ë©”ëª¨ì¥</h1>

        <!-- ë©”ëª¨ ì‘ì„± ì˜ì—­ -->
        <div class="flex flex-col md:flex-row gap-4 mb-10 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
            <!-- ì…ë ¥ í…ìŠ¤íŠ¸ ì˜ì—­ -->
            <textarea id="note-input" rows="5" placeholder="ë‚˜ë§Œì˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì´ ë©”ëª¨ëŠ” ì‚¬ìš©ìë‹˜ê»˜ë§Œ ì €ì¥ë©ë‹ˆë‹¤)" 
                      class="flex-grow p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out resize-none"></textarea>
            
            <!-- ì…ë ¥ ë²„íŠ¼ -->
            <div class="flex md:flex-col items-stretch">
                <button onclick="saveNote()" id="save-note-btn"
                        class="w-full md:w-auto px-6 py-3 text-white font-semibold bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center justify-center whitespace-nowrap disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    ì…ë ¥
                </button>
            </div>
        </div>
        
        <!-- ì¸ì¦ ìƒíƒœ ë° ì‚¬ìš©ì ID í‘œì‹œ (ë¹„ê³µê°œ ê²½ë¡œì„ì„ ê°•ì¡°) -->
        <p id="auth-status" class="text-center text-sm text-yellow-600 mb-4 font-semibold">ì¸ì¦ ë° ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘... (í˜„ì¬ ê°œì¸ ë©”ëª¨ ëª¨ë“œ)</p>
        
        <!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ ì œëª© -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">ë‚˜ë§Œì˜ ë©”ëª¨ ëª©ë¡</h2>
        
        <!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ (ê°€ìš´ë° ì •ë ¬) -->
        <div class="w-full">
            <ul id="noteList" class="mx-auto">
                <!-- ë©”ëª¨ ì¹´ë“œê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
            </ul>
        </div>
        
        <!-- í˜ì´ì§€ ë„¤ì´ì…˜ ì˜ì—­ -->
        <div id="pagination-controls" class="flex justify-center items-center gap-2 mt-6">
            <!-- í˜ì´ì§€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
        </div>
        <p id="no-notes-message" class="text-center text-gray-500 mt-10 hidden">ì €ì¥ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì— ë©”ëª¨ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!</p>
    </div>

    <!-- ì»¤ìŠ¤í…€ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ë©”ëª¨ ìˆ˜ì •</h3>
            <textarea id="edit-text" rows="8" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ì·¨ì†Œ</button>
                <button id="save-edit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase UMD Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // signInWithCustomTokenì€ ì¼ë°˜ ì›¹ ë°°í¬ ì‹œ ì œê±°í•©ë‹ˆë‹¤.
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ê°œë°œ ì¤‘ Firestore ë¡œê·¸ í™•ì¸ìš©
        // setLogLevel('debug'); 

        // ğŸš¨ğŸš¨ğŸš¨ [ì¤‘ìš”] ì‚¬ìš©ìê°€ ì œê³µí•œ ì‹¤ì œ Firebase ì„¤ì • ê°’ì„ ì§ì ‘ ì…ë ¥í–ˆìŠµë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBq4P9oCU6pzJFRv_xxJyvG9moYjlHTeys",           
            authDomain: "memo-f8ef8.firebaseapp.com",  
            projectId: "memo-f8ef8",     
            storageBucket: "memo-f8ef8.firebasestorage.app",
            messagingSenderId: "92169207764",
            appId: "1:92169207764:web:b2b078dcfe8d38dcf62041",
            measurementId: "G-X6GT0JDL7S" 
        };

        // --- 1. ì „ì—­ ìƒìˆ˜ ë° ë³€ìˆ˜ ì„¤ì • ---
        const NOTES_PER_PAGE = 20; 

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; 
        
        let allNotes = []; 
        let currentPage = 1; 

        const noteInput = document.getElementById("note-input");
        const noteList = document.getElementById("noteList");
        const paginationControls = document.getElementById("pagination-controls");
        const noNotesMessage = document.getElementById('no-notes-message');
        const editModal = document.getElementById('edit-modal');
        const editTextarea = document.getElementById('edit-text');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const authStatus = document.getElementById('auth-status');

        // --- 2. Firestore ì»¬ë ‰ì…˜ ì°¸ì¡° í•¨ìˆ˜ (***ì¼ë°˜ ì›¹ ë°°í¬ ê²½ë¡œ ì‚¬ìš©***) ---
        function getNotesCollectionRef() {
            if (!userId) {
                throw new Error("User ID is required for private collection reference.");
            }
            // ì¼ë°˜ ì›¹ ë°°í¬ ì‹œ ê²½ë¡œ: /users/{userId}/notes
            return collection(db, `users/${userId}/notes`); 
        }


        // --- 3. Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---
        async function initFirebase() {
            try {
                // ğŸš© ì œê³µëœ FIREBASE_CONFIGë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ˆê¸°í™”
                if (!FIREBASE_CONFIG.apiKey) {
                     authStatus.textContent = "ì˜¤ë¥˜: Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.";
                     return;
                }
                
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•´ persistence ì„¤ì •
                await setPersistence(auth, browserSessionPersistence);


                // 3-1. ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ì²˜ë¦¬
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // ì‚¬ìš©ì IDë¥¼ í‘œì‹œ (ë¹„ê³µê°œ ê²½ë¡œì„ì„ ëª…ì‹œ)
                        authStatus.textContent = `âœ… ì—°ê²°ë¨ - ë¹„ê³µê°œ ëª¨ë“œ (User ID: ${userId})`;
                        saveNoteBtn.disabled = false;
                        loadNotesRealtime(); // ì¸ì¦ í›„ ì‹¤ì‹œê°„ ë¡œë“œ ì‹œì‘
                    } else {
                        // ìµëª… ë¡œê·¸ì¸ ì‹œë„ (GitHub Pages ë°°í¬ í™˜ê²½ì˜ ê¸°ë³¸ ì¸ì¦ ë°©ì‹)
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™”/ì¸ì¦ ì˜¤ë¥˜:", error);
                authStatus.textContent = "ì˜¤ë¥˜: Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
                showToast("Firebase ì—°ê²° ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.", 'bg-red-700');
            }
        }

        // --- 4. ë©”ëª¨ ì €ì¥ (Create) ---
        window.saveNote = async function() {
            if (!isAuthReady || !userId) {
                showToast("ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘ì´ê±°ë‚˜ ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", 'bg-yellow-500');
                return;
            }

            const text = noteInput.value.trim();
            if (!text) {
                showToast("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'bg-red-500');
                return;
            }
            
            try {
                const newNote = { 
                    content: text, 
                    date: new Date().toISOString(), 
                    creatorId: userId 
                };
                
                await addDoc(getNotesCollectionRef(), newNote);
                
                noteInput.value = ""; 
                showToast("ë©”ëª¨ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentPage = 1;
            } catch (error) {
                console.error("ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:", error);
                showToast("ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë³´ì•ˆ ê·œì¹™ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)", 'bg-red-500');
            }
        }

        // --- 5. ë©”ëª¨ ìˆ˜ì • (Update) ---
        window.updateNote = async function(noteId, newText) {
            if (!isAuthReady || !userId) return;

            try {
                const noteRef = doc(getNotesCollectionRef(), noteId);
                
                await updateDoc(noteRef, {
                    content: newText,
                    date: new Date().toISOString()
                });
                
                showToast("ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.closeModal();
            } catch (error) {
                console.error("ë©”ëª¨ ìˆ˜ì • ì˜¤ë¥˜:", error);
                showToast("ë©”ëª¨ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ê¶Œí•œ ì—†ìŒ)", 'bg-red-500');
            }
        }

        // --- 6. ë©”ëª¨ ì‚­ì œ (Delete) ---
        window.deleteNote = async function(noteId) {
            if (!isAuthReady || !userId) return;

            try {
                const noteRef = doc(getNotesCollectionRef(), noteId);
                await deleteDoc(noteRef);
                
                showToast("ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
                console.error("ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:", error);
                showToast("ë©”ëª¨ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ê¶Œí•œ ì—†ìŒ)", 'bg-red-500');
            }
        }

        // --- 7. ë©”ëª¨ ì‹¤ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° (Read - Realtime Snapshot) ---
        function loadNotesRealtime() {
            if (!db || !isAuthReady || !userId) return;

            onSnapshot(getNotesCollectionRef(), (querySnapshot) => {
                const fetchedNotes = [];
                querySnapshot.forEach((doc) => {
                    fetchedNotes.push({ id: doc.id, ...doc.data() });
                });

                allNotes = fetchedNotes.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA;
                });
                
                if (allNotes.length === 0) {
                    noteList.innerHTML = '';
                    noNotesMessage.classList.remove('hidden');
                    paginationControls.innerHTML = '';
                } else {
                    noNotesMessage.classList.add('hidden');
                    window.renderNotes();
                    window.renderPagination();
                }
            }, (error) => {
                console.error("Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                showToast("ë©”ëª¨ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë³´ì•ˆ ê·œì¹™ í™•ì¸)", 'bg-red-500');
            });
        }
        
        // --- 8. UI ë Œë”ë§ ë° í˜ì´ì§€ë„¤ì´ì…˜ ---

        window.renderNotes = function() {
            noteList.innerHTML = "";
            const totalNotes = allNotes.length;
            const totalPages = Math.ceil(totalNotes / NOTES_PER_PAGE);
            
            if (currentPage > totalPages) currentPage = totalPages || 1;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * NOTES_PER_PAGE;
            const endIndex = Math.min(startIndex + NOTES_PER_PAGE, totalNotes);
            const notesToShow = allNotes.slice(startIndex, endIndex);

            notesToShow.forEach(note => {
                const li = document.createElement("li");
                li.className = 'note-card';

                const dateObj = new Date(note.date);
                const dateString = dateObj.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\s/g, '').replace(/\.$/, '');
                
                const encodedContent = encodeURIComponent(note.content);

                li.innerHTML = `
                    <div class="flex flex-col flex-grow">
                        <p class="text-xs font-semibold text-indigo-500 mb-2">${dateString}</p>
                        <p class="note-content">${note.content}</p>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button class="edit-btn px-3 py-1 text-sm text-indigo-600 border border-indigo-200 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition" data-id="${note.id}" onclick="openEditModal('${note.id}', '${encodedContent}')">ìˆ˜ì •</button>
                        <button class="delete-btn px-3 py-1 text-sm text-red-600 border border-red-200 bg-red-50 rounded-lg hover:bg-red-100 transition" data-id="${note.id}" onclick="deleteNote('${note.id}')">ì‚­ì œ</button>
                    </div>
                `;
                noteList.appendChild(li);
            });

            window.renderPagination();
        }

        window.renderPagination = function() {
            paginationControls.innerHTML = "";
            const totalPages = Math.ceil(allNotes.length / NOTES_PER_PAGE);

            if (totalPages <= 1) return;

            const prevBtn = createPageButton('ì´ì „', currentPage - 1, currentPage > 1);
            paginationControls.appendChild(prevBtn);

            let startPage = Math.max(1, currentPage - 3);
            let endPage = Math.min(totalPages, currentPage + 3);

            if (currentPage <= 4) endPage = Math.min(totalPages, 7);
            if (currentPage > totalPages - 3) startPage = Math.max(1, totalPages - 6);


            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i, i, true, i === currentPage);
                paginationControls.appendChild(pageBtn);
            }

            const nextBtn = createPageButton('ë‹¤ìŒ', currentPage + 1, currentPage < totalPages);
            paginationControls.appendChild(nextBtn);
        }

        function createPageButton(text, pageIndex, isEnabled, isActive = false) {
            const button = document.createElement('button');
            button.textContent = text;
            button.disabled = !isEnabled; 

            button.className = `px-3 py-1 rounded-lg text-sm font-medium transition ${
                isActive 
                    ? 'bg-indigo-600 text-white shadow-md' 
                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-indigo-50 hover:text-indigo-600'
            } ${isEnabled ? '' : 'opacity-50 cursor-not-allowed'}`;

            if (isEnabled) {
                button.addEventListener('click', () => {
                    currentPage = pageIndex;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    window.renderNotes(); 
                    window.renderPagination();
                });
            }
            return button;
        }

        // --- 9. ì»¤ìŠ¤í…€ UI/ë©”ì‹œì§€ í•¨ìˆ˜ ---
        window.openEditModal = function(id, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            
            editTextarea.value = content;
            editModal.style.display = 'flex';
            
            saveEditBtn.onclick = function() {
                const newText = editTextarea.value.trim();
                if (newText && newText !== content.trim()) {
                    window.updateNote(id, newText);
                } else {
                    window.closeModal();
                }
            };
            
            editTextarea.focus(); 
        }

        window.closeModal = function() {
            editModal.style.display = 'none';
        }

        function showToast(message, bgColor = 'bg-indigo-500') {
            let toast = document.getElementById('custom-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'custom-toast';
                toast.className = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white shadow-xl transition-opacity duration-300 z-50';
                document.body.appendChild(toast);
            }
            
            toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white shadow-xl transition-opacity duration-300 z-50 ${bgColor}`;
            toast.textContent = message;
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        // --- 10. ì´ˆê¸°í™” ---
        initFirebase();

    </script>
</body>
</html>
