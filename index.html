<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firestore ë©”ëª¨ì¥</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');

body {
    font-family: 'Pretendard', sans-serif;
    background-color: #f3f4f6;
}

.note-content {
    white-space: normal;
}

.note-content img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 10px;
    margin: 10px 0;
}

/* ëª¨ë‹¬ */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
}
.modal.active { display: flex; }
</style>
</head>

<body class="p-6">
<div class="max-w-4xl mx-auto">

<h1 class="text-3xl font-bold text-center mb-6">ğŸ“ Firestore ë©”ëª¨ì¥</h1>

<!-- ë¡œê·¸ì¸ ìƒíƒœ -->
<div class="bg-white p-4 rounded shadow mb-6 flex justify-between">
    <span id="auth-status">Google ë¡œê·¸ì¸ í•„ìš”</span>
    <span id="user-display" class="text-sm text-gray-500"></span>
</div>

<!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
<div class="flex justify-end mb-3">
    <button id="login-btn" onclick="signInWithGoogle()" class="px-4 py-2 bg-blue-600 text-white rounded">Google ë¡œê·¸ì¸</button>
    <button id="logout-btn" onclick="signOutUser()" class="px-4 py-2 bg-gray-500 text-white rounded hidden ml-2">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- ë©”ëª¨ ì‘ì„± -->
<textarea id="note-input" rows="5" class="w-full p-4 border rounded mb-3" placeholder="Markdown ì§€ì› ë©”ëª¨..." disabled></textarea>
<button id="save-btn" onclick="saveNote()" class="w-full bg-indigo-600 text-white py-2 rounded disabled:opacity-50" disabled>ì €ì¥</button>

<ul id="noteList" class="mt-8 space-y-6"></ul>

</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal">
    <div class="bg-white p-6 rounded-xl w-full max-w-xl">
        <h2 class="text-xl font-bold mb-3">ë©”ëª¨ ìˆ˜ì •</h2>

        <textarea id="edit-input" rows="6" class="w-full p-3 border rounded"></textarea>

        <div class="flex justify-end gap-2 mt-4">
            <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-400 text-white rounded">ì·¨ì†Œ</button>
            <button onclick="saveEdit()" class="px-4 py-2 bg-indigo-600 text-white rounded">ì €ì¥</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyBq4P9oCU6pzJFRv_xxJyvG9moYjlHTeys",
    authDomain: "memo-f8ef8.firebaseapp.com",
    projectId: "memo-f8ef8",
    storageBucket: "memo-f8ef8.firebasestorage.app",
    messagingSenderId: "92169207764",
    appId: "1:92169207764:web:b2b078dcfe8d38dcf62041"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let userId = null;
let allNotes = [];
let editingId = null;

const noteInput = document.getElementById("note-input");
const editInput = document.getElementById("edit-input");

/* ë¡œê·¸ì¸ */
window.signInWithGoogle = async () => {
    await signInWithPopup(auth, new GoogleAuthProvider());
};
window.signOutUser = async () => {
    await signOut(auth);
};

onAuthStateChanged(auth, user => {
    if (user) {
        userId = user.uid;
        document.getElementById("auth-status").textContent = "";
        document.getElementById("user-display").textContent = user.email;
        login-btn.classList.add("hidden");
        logout-btn.classList.remove("hidden");
        noteInput.disabled = false;
        save-btn.disabled = false;
        loadNotes();
    } else {
        userId = null;
        allNotes = [];
        renderNotes();
    }
});

function notesRef() {
    return collection(db, `users/${userId}/notes`);
}

/* ì €ì¥ */
window.saveNote = async () => {
    if (!noteInput.value.trim()) return;
    await addDoc(notesRef(), {
        content: noteInput.value,
        date: new Date().toISOString()
    });
    noteInput.value = "";
    loadNotes();
};

/* ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadNotes() {
    const snap = await getDocs(notesRef());
    allNotes = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b)=> new Date(b.date)-new Date(a.date));
    renderNotes();
}

/* ë Œë” */
function renderNotes() {
    const list = document.getElementById("noteList");
    list.innerHTML = "";
    allNotes.forEach(n => {
        const li = document.createElement("li");
        li.className = "bg-white p-4 rounded shadow";
        li.innerHTML = `
            <div class="text-xs text-gray-500 mb-2">${new Date(n.date).toLocaleString()}</div>
            <div class="note-content mb-3">${marked.parse(n.content)}</div>
            <div class="flex gap-2">
                <button class="bg-indigo-100 px-3 py-1 rounded" onclick="openEdit('${n.id}')">ìˆ˜ì •</button>
                <button class="bg-red-100 px-3 py-1 rounded" onclick="deleteNote('${n.id}')">ì‚­ì œ</button>
            </div>
        `;
        list.appendChild(li);
    });
}

/* ì‚­ì œ */
window.deleteNote = async id => {
    if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
    await deleteDoc(doc(db, `users/${userId}/notes/${id}`));
    loadNotes();
};

/* ìˆ˜ì • ëª¨ë‹¬ */
window.openEdit = id => {
    const note = allNotes.find(n => n.id === id);
    editingId = id;
    editInput.value = note.content;
    document.getElementById("editModal").classList.add("active");
};
window.closeEditModal = () => {
    document.getElementById("editModal").classList.remove("active");
};

/* ìˆ˜ì • ì €ì¥ */
window.saveEdit = async () => {
    await updateDoc(doc(db, `users/${userId}/notes/${editingId}`), {
        content: editInput.value,
        date: new Date().toISOString()
    });
    closeEditModal();
    loadNotes();
};

/* ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° (ì‘ì„±/ìˆ˜ì • ê³µí†µ) */
async function handlePaste(e, target) {
    for (const item of e.clipboardData.items) {
        if (item.type.startsWith("image")) {
            const file = item.getAsFile();
            const fileRef = ref(storage, `users/${userId}/images/${Date.now()}.png`);
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            target.value += `\n![](${url})\n`;
        }
    }
}

noteInput.addEventListener("paste", e => handlePaste(e, noteInput));
editInput.addEventListener("paste", e => handlePaste(e, editInput));

</script>
</body>
</html>
